<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>강의 채팅 테스트 (중복 방지 포함)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        #chat, #users { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        #message { width: 80%; }
        .connected { background-color: #4CAF50; color: white; }
        .disconnected { background-color: #f44336; color: white; }
    </style>
</head>
<body>
<h2>강의 채팅 테스트 (중복 방지 포함)</h2>

<label>강의 ID (roomId): <input type="text" id="roomId" value="lecture-123"></label><br>
<label>유저 ID (userId): <input type="text" id="userId" value="user1"></label><br>
<label>유저 이름 (userName): <input type="text" id="userName" value="jungry"></label><br><br>

<div><strong>채팅:</strong></div>
<div id="chat"></div>

<input type="text" id="message" placeholder="메시지 입력">
<button onclick="sendMessage()">보내기</button>
<button id="connectBtn" class="disconnected" onclick="connect()">연결</button>
<button onclick="disconnect()">연결 끊기</button>

<br><br>
<div><strong>현재 접속자:</strong></div>
<div id="users"></div>

<script>
    let stompClient = null;
    let roomId = null;
    let userId = null;
    let userName = null;
    let userListInterval = null;

    function connect() {
        if (stompClient && stompClient.connected) {
            appendMessage('⚠ 이미 연결되어 있습니다.');
            return;
        }

        roomId = document.getElementById('roomId').value.trim();
        userId = document.getElementById('userId').value.trim();
        userName = document.getElementById('userName').value.trim();

        const socket = new SockJS('http://localhost:8080/ws-chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            appendMessage('✅ 서버 연결됨');
            document.getElementById('connectBtn').classList.remove('disconnected');
            document.getElementById('connectBtn').classList.add('connected');

            stompClient.subscribe('/topic/' + roomId, function (message) {
                const chat = JSON.parse(message.body);
                appendMessage(chat.userName + ' ➡ ' + chat.message);
            });

            stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                roomId: roomId,
                userId: userId,
                userName: userName
            }));

            if (!userListInterval) {
                userListInterval = setInterval(fetchUserList, 3000);
            }
        }, function (error) {
            appendMessage('❌ 연결 실패: ' + error);
        });
    }

    function sendMessage() {
        const messageContent = document.getElementById('message').value.trim();
        if (messageContent && stompClient && stompClient.connected) {
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                roomId: roomId,
                userId: userId,
                userName: userName,
                message: messageContent
            }));
            document.getElementById('message').value = '';
        }
    }

    function disconnect() {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/chat.leaveUser", {}, JSON.stringify({
                roomId: roomId,
                userId: userId,
                userName: userName
            }));
            stompClient.disconnect(() => {
                appendMessage('❌ 서버 연결 종료됨');
                clearInterval(userListInterval);
                userListInterval = null;
                document.getElementById('users').innerHTML = '';
                stompClient = null;
                document.getElementById('connectBtn').classList.remove('connected');
                document.getElementById('connectBtn').classList.add('disconnected');
            });
        }
    }

    function fetchUserList() {
        fetch('http://localhost:8080/api/chat/users/' + roomId)
            .then(response => response.json())
            .then(users => {
                document.getElementById('users').innerHTML = Array.from(users).join('<br>');
            }).catch(err => {
            console.error('유저 목록 불러오기 실패:', err);
        });
    }

    function appendMessage(message) {
        const chat = document.getElementById('chat');
        const messageElement = document.createElement('div');
        messageElement.textContent = message;
        chat.appendChild(messageElement);
        chat.scrollTop = chat.scrollHeight;
    }
</script>
</body>
</html>
